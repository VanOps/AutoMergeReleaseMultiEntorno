---
name: ðŸš€ Release Multi-Environment Pipeline

on:
  push:
    branches:
      - "release/**"

  workflow_dispatch:
    inputs:
      environment:
        description: "Target environment"
        required: true
        type: choice
        options:
          - qa
          - staging
          - production
      release_branch:
        description: "Release branch (e.g., release/v2.0)"
        required: true
        type: string

concurrency:
  group: release-${{ github.ref_name }}-${{ inputs.environment || 'qa' }}
  cancel-in-progress: false

env:
  NODE_VERSION: "20"
  RELEASE_VERSION: ${{ github.ref_name }}

jobs:
  # ============================================
  # JOB 1: BUILD
  # ============================================
  build:
    name: ðŸ—ï¸ Build Release Artifacts
    runs-on: ubuntu-latest

    defaults:
      run:
        working-directory: ./src/app

    steps:
      - name: ðŸ“¥ Checkout release branch
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.release_branch || github.ref }}

      - name: ðŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: ðŸ“¦ Install dependencies
        run: npm install

      - name: ðŸ§ª Run linter
        run: npm run lint

      - name: ðŸ—ï¸ Build application
        run: npm run build
        env:
          CI: true
          NEXT_TELEMETRY_DISABLED: 1

      - name: ðŸ“Š Generate version info
        run: |
          echo "VERSION=${GITHUB_REF_NAME}" > version.txt
          echo "COMMIT=${GITHUB_SHA::7}" >> version.txt
          echo "BUILD_DATE=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> version.txt
          cp version.txt .next/

      - name: ðŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: release-build-${{ github.sha }}
          path: |
            src/app/.next/
            src/app/package.json
            src/app/public/
          retention-days: 30

      - name: ðŸ“Š Build Summary
        run: |
          echo "### ðŸ—ï¸ Build Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${GITHUB_REF_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: ${GITHUB_SHA::7}" >> $GITHUB_STEP_SUMMARY
          echo "- **Node**: ${{ env.NODE_VERSION }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 2: DEPLOY TO QA (Automatic)
  # ============================================
  deploy-qa:
    name: ðŸ§ª Deploy to QA
    needs: build
    runs-on: ubuntu-latest
    environment:
      name: qa
      url: https://qa.tuapp.com

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ github.sha }}
          path: ./build

      - name: ðŸ” Verify artifacts
        run: |
          echo "ðŸ“¦ Artifact contents:"
          ls -lah ./build

      - name: ðŸš€ Deploy to QA
        run: |
          echo "ðŸ§ª Deploying to QA environment..."
          echo "API_URL: ${{ vars.QA_API_URL || 'https://api-qa.tuapp.com' }}"
          echo "ENV_NAME: ${{ vars.ENV_NAME || 'qa' }}"
          # AquÃ­ tu lÃ³gica de deploy (AWS, Azure, Vercel, etc.)
          # Ejemplo: vercel deploy --env=qa
          # Ejemplo: aws s3 sync ./build s3://qa-bucket

      - name: â³ Wait for deployment
        run: sleep 10

      - name: ðŸ§ª Run QA Smoke Tests
        run: |
          echo "ðŸ§ª Running QA smoke tests..."
          # npm run test:smoke -- --env=qa

      - name: ðŸ“Š QA Health Check
        run: |
          echo "ðŸ’š Checking QA health..."
          # curl -f ${{ vars.QA_API_URL }}/health || exit 1
          echo "âœ… QA deployment successful!"

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "### ðŸ§ª QA Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://qa.tuapp.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 3: DEPLOY TO STAGING (Manual Approval)
  # ============================================
  deploy-staging:
    name: ðŸŽ­ Deploy to Staging
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment:
      name: staging
      url: https://staging.tuapp.com

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ github.sha }}
          path: ./build

      - name: ðŸš€ Deploy to Staging
        run: |
          echo "ðŸŽ­ Deploying to Staging environment..."
          echo "API_URL: ${{ vars.STAGING_API_URL || 'https://api-staging.tuapp.com' }}"
          echo "ENV_NAME: ${{ vars.ENV_NAME || 'staging' }}"
          # AquÃ­ tu lÃ³gica de deploy

      - name: â³ Wait for deployment
        run: sleep 10

      - name: ðŸ§ª Run UAT Tests
        run: |
          echo "ðŸ§ª Running UAT tests..."
          # npm run test:uat -- --env=staging

      - name: ðŸ“Š Staging Health Check
        run: |
          echo "ðŸ’š Checking Staging health..."
          # curl -f ${{ vars.STAGING_API_URL }}/health || exit 1
          echo "âœ… Staging deployment successful!"

      - name: ðŸ“Š Deployment Summary
        run: |
          echo "### ðŸŽ­ Staging Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://staging.tuapp.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Approved by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  # ============================================
  # JOB 4: CREATE RELEASE PR
  # ============================================
  create-release-pr:
    name: ðŸ“ Create Release PR to Main
    needs: deploy-staging
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ·ï¸ Create Release Tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          VERSION=${GITHUB_REF_NAME#release/}

          # Crear tag si no existe
          if ! git rev-parse "$VERSION" >/dev/null 2>&1; then
            git tag -a "$VERSION" -m "Release $VERSION"
            git push origin "$VERSION"
            echo "âœ… Tag $VERSION created"
          else
            echo "âš ï¸ Tag $VERSION already exists"
          fi

      - name: ðŸ“ Generate Release Notes
        id: release_notes
        run: |
          VERSION=${GITHUB_REF_NAME#release/}
          DEPLOY_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)

          # Copiar template y reemplazar variables
          cp .github/templates/release_pr_body.md release_notes.md
          sed -i "s/\${VERSION}/$VERSION/g" release_notes.md
          sed -i "s/\${DEPLOY_TIME}/$DEPLOY_TIME/g" release_notes.md

          echo "notes_file=release_notes.md" >> $GITHUB_OUTPUT

      - name: ðŸ” Check if PR exists
        id: check_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --head ${{ github.ref_name }} --base main --json number --jq '.[0].number // empty')

          if [ -n "$PR_EXISTS" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_EXISTS" >> $GITHUB_OUTPUT
            echo "âš ï¸ PR #$PR_EXISTS already exists"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "âœ… No existing PR found"
          fi

      - name: ðŸ·ï¸ Ensure Labels Exist
        if: steps.check_pr.outputs.pr_exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Crear labels si no existen (sin fallar si ya existen)
          gh label create "release" --color "0e8a16" --description "Release PR to production" --force 2>/dev/null || true
          gh label create "ready-to-merge" --color "0e8a16" --description "Ready for automatic merge" --force 2>/dev/null || true

      - name: ðŸ“ Create PR to Main
        if: steps.check_pr.outputs.pr_exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#release/}

          gh pr create \
            --base main \
            --head ${{ github.ref_name }} \
            --title "ðŸš€ Release: $VERSION" \
            --body-file release_notes.md \
            --label "release" \
            --label "ready-to-merge"

      - name: ðŸ”„ Update existing PR
        if: steps.check_pr.outputs.pr_exists == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr edit ${{ steps.check_pr.outputs.pr_number }} \
            --body-file release_notes.md

      - name: ðŸ¤– Enable Auto-Merge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=$(gh pr list --head ${{ github.ref_name }} --base main --json number --jq '.[0].number')

          if [ -n "$PR_NUMBER" ]; then
            gh pr merge $PR_NUMBER --auto --squash
            echo "âœ… Auto-merge enabled for PR #$PR_NUMBER"
          fi

  # ============================================
  # JOB 5: DEPLOY TO PRODUCTION
  # ============================================
  deploy-production:
    name: ðŸš€ Deploy to Production
    needs: create-release-pr
    runs-on: ubuntu-latest
    environment:
      name: production
      url: https://tuapp.com

    steps:
      - name: ðŸ“¥ Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: ðŸ“¥ Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: release-build-${{ github.sha }}
          path: ./build

      - name: ðŸš€ Deploy to Production
        run: |
          echo "ðŸš€ Deploying to Production..."
          echo "API_URL: ${{ vars.PROD_API_URL || 'https://api.tuapp.com' }}"
          echo "ENV_NAME: ${{ vars.ENV_NAME || 'production' }}"
          # AquÃ­ tu lÃ³gica de deploy

      - name: â³ Wait for deployment
        run: sleep 15

      - name: ðŸ“Š Production Health Check
        run: |
          echo "ðŸ’š Checking Production health..."
          # curl -f ${{ vars.PROD_API_URL }}/health || exit 1
          echo "âœ… Production deployment successful!"

      - name: ðŸ“Š Production Smoke Tests
        run: |
          echo "ðŸ§ª Running production smoke tests..."
          # npm run test:smoke:prod

      - name: ðŸ“¢ Deployment Summary
        run: |
          VERSION=${GITHUB_REF_NAME#release/}

          echo "### ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: $VERSION" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Deployed" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://tuapp.com" >> $GITHUB_STEP_SUMMARY
          echo "- **Deployed by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Time**: $(date -u +%Y-%m-%dT%H:%M:%SZ)" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ“¢ Notify Success
        if: success()
        run: |
          echo "ðŸŽ‰ âœ… Production deployment successful!"
          # AquÃ­ puedes agregar notificaciones a Slack, Teams, etc.

  # ============================================
  # JOB 6: BACK-MERGE TO DEVELOP
  # ============================================
  back-merge:
    name: ðŸ”„ Back-merge to Develop
    needs: deploy-production
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ðŸ”€ Create back-merge branch
        id: backmerge
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Crear rama temporal para el back-merge
          VERSION=${GITHUB_REF_NAME#release/}
          BACKMERGE_BRANCH="backmerge/main-to-develop-${VERSION}"

          git fetch origin develop
          git fetch origin main

          # Verificar si hay diferencias entre main y develop
          DIFF_COUNT=$(git rev-list --count origin/develop..origin/main)

          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "skip_backmerge=true" >> $GITHUB_OUTPUT
            echo "branch_name=$BACKMERGE_BRANCH" >> $GITHUB_OUTPUT
            echo "âš ï¸ No differences between main and develop - skipping back-merge"
            exit 0
          fi

          echo "skip_backmerge=false" >> $GITHUB_OUTPUT
          git checkout -b $BACKMERGE_BRANCH origin/develop

          # Intentar merge de main
          if git merge origin/main --no-ff -m "chore: Back-merge main to develop after production release $VERSION"; then
            git push origin $BACKMERGE_BRANCH
            echo "branch_name=$BACKMERGE_BRANCH" >> $GITHUB_OUTPUT
            echo "has_conflicts=false" >> $GITHUB_OUTPUT
            echo "âœ… Back-merge branch created successfully"
          else
            echo "has_conflicts=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Merge conflicts detected - will create PR for manual resolution"
            echo "branch_name=$BACKMERGE_BRANCH" >> $GITHUB_OUTPUT
            
            # No abortar el merge - crear la rama con conflictos para revisiÃ³n manual
            git add -A
            git commit -m "chore: Back-merge main to develop (CONFLICTS - requires manual resolution)" || true
            git push origin $BACKMERGE_BRANCH
          fi

      - name: ðŸ” Check if back-merge PR exists
        if: steps.backmerge.outputs.skip_backmerge != 'true'
        id: check_backmerge_pr
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_EXISTS=$(gh pr list --head ${{ steps.backmerge.outputs.branch_name }} --base develop --json number --jq '.[0].number // empty')

          if [ -n "$PR_EXISTS" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$PR_EXISTS" >> $GITHUB_OUTPUT
            echo "âš ï¸ Back-merge PR #$PR_EXISTS already exists"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ·ï¸ Ensure back-merge label exists
        if: steps.backmerge.outputs.skip_backmerge != 'true' && steps.check_backmerge_pr.outputs.pr_exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh label create "back-merge" --color "0366d6" --description "Automatic back-merge from main to develop" --force 2>/dev/null || true

      - name: ðŸ“ Create back-merge PR
        if: steps.backmerge.outputs.skip_backmerge != 'true' && steps.check_backmerge_pr.outputs.pr_exists != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION=${GITHUB_REF_NAME#release/}

          # Seleccionar template segÃºn si hay conflictos
          if [ "${{ steps.backmerge.outputs.has_conflicts }}" == "true" ]; then
            TEMPLATE=".github/templates/backmerge_pr_body_conflicts.md"
          else
            TEMPLATE=".github/templates/backmerge_pr_body.md"
          fi

          # Copiar template y reemplazar variables
          cp "$TEMPLATE" pr_body.md
          sed -i "s/\${VERSION}/$VERSION/g" pr_body.md

          gh pr create \
            --base develop \
            --head ${{ steps.backmerge.outputs.branch_name }} \
            --title "ðŸ”„ Back-merge: main â†’ develop (Release $VERSION)" \
            --body-file pr_body.md \
            --label "back-merge"

          PR_NUMBER=$(gh pr list --head ${{ steps.backmerge.outputs.branch_name }} --base develop --json number --jq '.[0].number')

          # Si no hay conflictos, habilitar auto-merge
          if [ "${{ steps.backmerge.outputs.has_conflicts }}" == "false" ]; then
            gh pr merge $PR_NUMBER --auto --merge || echo "âš ï¸ Could not enable auto-merge (may require approvals)"
          fi

      - name: ðŸ“Š Summary
        run: |
          VERSION=${GITHUB_REF_NAME#release/}

          echo "### ðŸ”„ Back-merge to Develop" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.backmerge.outputs.skip_backmerge }}" == "true" ]; then
            echo "- **Status**: â­ï¸ Skipped (develop already up to date)" >> $GITHUB_STEP_SUMMARY
            echo "- **Info**: No differences found between main and develop" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **From**: main" >> $GITHUB_STEP_SUMMARY
            echo "- **To**: develop (via PR)" >> $GITHUB_STEP_SUMMARY
            echo "- **Branch**: ${{ steps.backmerge.outputs.branch_name }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Conflicts**: ${{ steps.backmerge.outputs.has_conflicts == 'true' && 'âš ï¸ Yes - requires manual resolution' || 'âœ… No' }}" >> $GITHUB_STEP_SUMMARY
            
            if [ "${{ steps.check_backmerge_pr.outputs.pr_exists }}" == "true" ]; then
              echo "- **PR**: #${{ steps.check_backmerge_pr.outputs.pr_number }} (already exists)" >> $GITHUB_STEP_SUMMARY
            else
              echo "- **PR**: Created successfully" >> $GITHUB_STEP_SUMMARY
            fi
            echo "- **PR**: Created successfully" >> $GITHUB_STEP_SUMMARY
          fi

  # ============================================
  # JOB 7: CLEANUP
  # ============================================
  cleanup:
    name: ðŸ§¹ Cleanup
    needs: back-merge
    runs-on: ubuntu-latest
    if: always()

    steps:
      - name: ðŸ§¹ Delete artifacts
        uses: geekyeggo/delete-artifact@v5
        with:
          name: release-build-${{ github.sha }}

      - name: ðŸ“Š Pipeline Summary
        run: |
          echo "### ðŸŽ‰ Release Pipeline Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All environments deployed successfully!" >> $GITHUB_STEP_SUMMARY
